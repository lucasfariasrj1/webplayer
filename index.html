<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal IPTV Player</title>
    
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <style>
        :root { --primary: #e50914; --bg: #0b0b0b; --panel: #141414; --line: #2b2b2b; }
        
        body { 
            margin: 0; 
            background: var(--bg); 
            color: white; 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        /* Login Screen */
        #login-screen { 
            position: fixed; 
            inset: 0; 
            background: radial-gradient(circle at center, #222 0%, #000 100%); 
            z-index: 9999; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        .login-card { 
            background: var(--panel); 
            padding: 40px; 
            border-radius: 16px; 
            width: 100%; 
            max-width: 360px; 
            border: 1px solid var(--line);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        
        input, select { 
            width: 100%; 
            padding: 14px; 
            margin: 10px 0; 
            background: #000; 
            border: 1px solid #333; 
            color: white; 
            border-radius: 8px; 
            font-size: 16px;
            outline: none;
        }
        input:focus { border-color: var(--primary); }

        button { 
            width: 100%; 
            padding: 14px; 
            background: var(--primary); 
            border: none; 
            color: white; 
            font-weight: bold; 
            cursor: pointer; 
            border-radius: 8px; 
            font-size: 16px;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }

        /* App Layout */
        #app { display: none; flex: 1; height: 100vh; }
        
        .player-box { 
            flex: 1; 
            background: #000; 
            display: flex; 
            flex-direction: column;
            position: relative;
        }
        
        .sidebar { 
            width: 380px; 
            background: var(--panel); 
            border-left: 1px solid var(--line); 
            display: flex; 
            flex-direction: column; 
        }
        
        /* Video.js Customization */
        .video-js { width: 100% !important; height: 100% !important; }
        
        /* Lista */
        .list-header { padding: 20px; background: #000; border-bottom: 1px solid var(--line); }
        .list-container { flex: 1; overflow-y: auto; padding: 0; margin: 0; }
        .list-container li { 
            padding: 14px 20px; 
            border-bottom: 1px solid #1f1f1f; 
            cursor: pointer; 
            list-style: none; 
            font-size: 14px; 
            display: flex;
            align-items: center;
            transition: background 0.2s;
        }
        .list-container li:hover { background: #1f1f1f; }
        .list-container li.active { 
            background: #262626; 
            border-left: 4px solid var(--primary); 
            color: var(--primary); 
            font-weight: bold;
        }

        #status-msg { padding: 10px; font-size: 12px; color: #666; text-align: center; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-card">
        <h1 style="color:var(--primary); text-align:center; margin-top:0;">IPTV PLAYER</h1>
        <p style="text-align:center; color:#888; font-size:14px;">Insira suas credenciais Xtream</p>
        <input type="text" id="user" placeholder="Usu치rio">
        <input type="password" id="pass" placeholder="Senha">
        <button id="btn-entrar" onclick="carregarSistema()">ENTRAR NO PLAYER</button>
        <div id="login-status" style="margin-top:15px; font-size:13px; text-align:center; color:var(--primary);"></div>
    </div>
</div>

<div id="app">
    <div class="player-box">
        <video id="vid" class="video-js vjs-big-play-centered" controls playsinline preload="auto"></video>
        <div id="playing-now" style="padding:10px; background:rgba(0,0,0,0.7); position:absolute; bottom:50px; left:20px; border-radius:5px; pointer-events:none; display:none;"></div>
    </div>

    <div class="sidebar">
        <div class="list-header">
            <select id="main-cat" onchange="filtroMestre()"></select>
            <select id="sub-cat" onchange="renderizar()"></select>
            <input type="text" id="busca" placeholder="游댌 Buscar..." oninput="renderizar()">
        </div>
        <ul class="list-container" id="lista"></ul>
        <div id="status-msg">Pronto.</div>
    </div>
</div>

<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
<script>
    let db = { "TV AO VIVO": {}, "FILMES": {}, "S칄RIES": {} };
    let player;

    // Inicializa o Player
    document.addEventListener('DOMContentLoaded', () => {
        player = videojs('vid', {
            fluid: true,
            playbackRates: [0.5, 1, 1.5, 2],
            userActions: { hotkeys: true }
        });
    });

    async function carregarSistema() {
        const u = document.getElementById('user').value.trim();
        const p = document.getElementById('pass').value.trim();
        const status = document.getElementById('login-status');
        const btn = document.getElementById('btn-entrar');

        if(!u || !p) {
            status.innerText = "Preencha todos os campos.";
            return;
        }

        btn.disabled = true;
        btn.innerText = "CARREGANDO...";
        status.innerText = "Obtendo lista M3U...";

        // URL Xtream corrigida
        const rawUrl = `https://ded38.com/get.php?username=${u}&password=${p}&type=m3u_plus&output=ts`;
        const proxyUrl = `proxy.php?url=${encodeURIComponent(rawUrl)}`;
        
        try {
            const res = await fetch(proxyUrl);
            const data = await res.text();
            
            if(!data.includes("#EXTM3U")) {
                throw new Error("Resposta inv치lida do servidor.");
            }
            
            parsearM3U(data);
            
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
        } catch(e) { 
            console.error(e);
            alert("Erro ao conectar. Verifique usu치rio e senha ou se o proxy.php est치 funcionando."); 
            btn.disabled = false;
            btn.innerText = "ENTRAR";
            status.innerText = "";
        }
    }

    function parsearM3U(text) {
        const lines = text.split(/\r?\n/);
        db = { "TV AO VIVO": {}, "FILMES": {}, "S칄RIES": {} }; // Reset

        for (let i = 0; i < lines.length; i++) {
            if (lines[i].startsWith('#EXTINF:')) {
                const info = lines[i];
                const link = lines[i + 1] ? lines[i + 1].trim() : null;

                if (link && link.startsWith('http')) {
                    const group = info.match(/group-title="([^"]+)"/)?.[1] || "GERAL";
                    const name = info.split(',').pop().trim();

                    let tipo = "TV AO VIVO";
                    if (link.includes("/movie/")) tipo = "FILMES";
                    else if (link.includes("/series/")) tipo = "S칄RIES";

                    if (!db[tipo][group]) db[tipo][group] = [];
                    db[tipo][group].push({ name, link });
                }
            }
        }

        // Popula as categorias principais
        const mainSelect = document.getElementById('main-cat');
        mainSelect.innerHTML = "";
        Object.keys(db).forEach(t => {
            if(Object.keys(db[t]).length > 0) {
                mainSelect.innerHTML += `<option value="${t}">${t}</option>`;
            }
        });
        
        filtroMestre();
    }

    function filtroMestre() {
        const t = document.getElementById('main-cat').value;
        const subSelect = document.getElementById('sub-cat');
        subSelect.innerHTML = "";
        
        const grupos = Object.keys(db[t]).sort();
        grupos.forEach(g => {
            subSelect.innerHTML += `<option value="${g}">${g}</option>`;
        });
        
        renderizar();
    }

    function renderizar() {
        const t = document.getElementById('main-cat').value;
        const g = document.getElementById('sub-cat').value;
        const busca = document.getElementById('busca').value.toLowerCase();
        const listaUI = document.getElementById('lista');
        
        listaUI.innerHTML = "";

        if(!db[t] || !db[t][g]) return;

        const itensFiltrados = db[t][g].filter(i => i.name.toLowerCase().includes(busca));
        
        // Mostrar apenas os primeiros 100 para performance
        itensFiltrados.slice(0, 100).forEach(item => {
            const li = document.createElement('li');
            li.innerHTML = `<span>${item.name}</span>`;
            li.onclick = () => {
                document.querySelectorAll('#lista li').forEach(el => el.classList.remove('active'));
                li.classList.add('active');
                playVideo(item.link, item.name);
            };
            listaUI.appendChild(li);
        });

        document.getElementById('status-msg').innerText = `${itensFiltrados.length} itens encontrados`;
    }

    function playVideo(url, name) {
        // Exibe nome do que est치 passando
        const titleBox = document.getElementById('playing-now');
        titleBox.innerText = `Reproduzindo: ${name}`;
        titleBox.style.display = 'block';

        // Determina tipo de m칤dia
        let type = 'application/x-mpegURL'; // Padr칚o HLS/TS
        if(url.toLowerCase().includes('.mp4')) type = 'video/mp4';

        // Reset completo do player para carregar nova fonte sem erros
        player.pause();
        player.reset(); 
        
        // Passa pelo proxy obrigatoriamente
        const proxiedSource = `proxy.php?url=${encodeURIComponent(url)}`;

        player.src({ type: type, src: proxiedSource });
        player.load();
        
        player.play().catch(e => {
            console.warn("Erro no play autom치tico:", e);
        });
    }
</script>

</body>
</html>